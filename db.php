<?php
/**
 * Gestion de la base de donnÃ©es SQLite
 */

require_once 'config.php';

class Database {
    private static $instance = null;
    private $pdo;

    private function __construct() {
        try {
            $this->pdo = new PDO('sqlite:' . DB_PATH);
            $this->pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            $this->pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
            
            // CrÃ©er les tables si elles n'existent pas
            $this->createTables();
            
            // InsÃ©rer les questions si la table est vide
            $this->seedQuestions();
            
        } catch (PDOException $e) {
            die('Erreur de connexion Ã  la base de donnÃ©es : ' . $e->getMessage());
        }
    }

    public static function getInstance() {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    public function getPDO() {
        return $this->pdo;
    }

    private function createTables() {
        $sql = "
        CREATE TABLE IF NOT EXISTS sessions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            pin TEXT UNIQUE NOT NULL,
            status TEXT DEFAULT 'open',
            current_question_index INTEGER DEFAULT -1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        );

        CREATE TABLE IF NOT EXISTS questions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            qtext TEXT NOT NULL,
            qtype TEXT NOT NULL,
            choices TEXT NOT NULL,
            correct_indices TEXT NOT NULL,
            confirm_text TEXT NOT NULL,
            explain_text TEXT NOT NULL,
            explain_media TEXT NOT NULL,
            seconds INTEGER NOT NULL,
            points INTEGER NOT NULL
        );

        CREATE TABLE IF NOT EXISTS responses (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            session_id INTEGER NOT NULL,
            question_id INTEGER NOT NULL,
            user_name TEXT NOT NULL,
            answer_indices TEXT NOT NULL,
            is_correct INTEGER NOT NULL,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (session_id) REFERENCES sessions(id),
            FOREIGN KEY (question_id) REFERENCES questions(id)
        );
        ";

        $this->pdo->exec($sql);
    }

    private function seedQuestions() {
        // VÃ©rifier si des questions existent dÃ©jÃ 
        $stmt = $this->pdo->query("SELECT COUNT(*) as count FROM questions");
        $result = $stmt->fetch();
        
        if ($result['count'] > 0) {
            return; // Les questions sont dÃ©jÃ  prÃ©sentes
        }

        $questions = [
            // Brise-glace (non notÃ©es)
            [
                'qtext' => 'Bienvenue dans Â« Mission Cycle Â» : ici on apprend sans jugement ðŸ’›.',
                'qtype' => 'truefalse',
                'choices' => ['Vrai', 'Faux'],
                'correct_indices' => [0],
                'confirm_text' => 'Merci d\'Ãªtre lÃ  !',
                'explain_text' => 'Objectif : casser les tabous, partager des infos fiables et des astuces de confort.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 10,
                'points' => 0
            ],
            [
                'qtext' => 'On reste bienveillantÂ·eÂ·s et on pose des questions si un mot n\'est pas clair.',
                'qtype' => 'truefalse',
                'choices' => ['Vrai', 'Faux'],
                'correct_indices' => [0],
                'confirm_text' => 'Bienveillance & clartÃ© avant tout.',
                'explain_text' => 'Aucune question n\'est Â« bÃªte Â». On avance ensemble.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 10,
                'points' => 0
            ],
            // Faits clÃ©s
            [
                'qtext' => 'Combien de jours une femme est-elle menstruÃ©e au cours de sa vie (en moyenne) ?',
                'qtype' => 'quiz',
                'choices' => ['1200', '2000', '2400', '3000'],
                'correct_indices' => [2],
                'confirm_text' => 'RÃ©ponse : 2400 jours.',
                'explain_text' => 'â‰ˆ 5 jours/mois Ã— 12 mois Ã— ~40 ans (dÃ©but ~12 ans, fin ~51 ans) â‰ˆ 2 400 jours. Le vÃ©cu varie.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 30,
                'points' => 1
            ],
            [
                'qtext' => 'Ã€ combien revient l\'achat de protections jetables au cours d\'une vie ?',
                'qtype' => 'quiz',
                'choices' => ['1 800 â‚¬', '2 800 â‚¬', '3 800 â‚¬', '5 800 â‚¬'],
                'correct_indices' => [2],
                'confirm_text' => 'Environ 3 800 â‚¬ pour les jetables.',
                'explain_text' => 'Avec extras (culottes, dÃ©tachants, bouillotte, consultationsâ€¦), le total peut approcher ~5 800 â‚¬. Les rÃ©utilisables rÃ©duisent le coÃ»t et les dÃ©chets.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 30,
                'points' => 1
            ],
            [
                'qtext' => 'La prÃ©caritÃ© menstruelle, c\'estâ€¦',
                'qtype' => 'quiz',
                'choices' => ['DifficultÃ© Ã  acheter des protections Ã  cause de faibles revenus', 'DifficultÃ© Ã  se procurer des vÃªtements', 'DifficultÃ© Ã  aller Ã  l\'Ã©cole', 'Manque de temps'],
                'correct_indices' => [0],
                'confirm_text' => 'Exact.',
                'explain_text' => 'En France, ~1 personne menstruÃ©e/3 est concernÃ©e : impact scolaritÃ©, travail, santÃ©. Pistes : distributions, boÃ®tes Ã  dons, rÃ©utilisables.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 25,
                'points' => 1
            ],
            [
                'qtext' => 'On perd en moyenne l\'Ã©quivalent d\'1 Ã  3 cuillÃ¨res Ã  soupe de sang par cycle (~30â€“40 ml).',
                'qtype' => 'truefalse',
                'choices' => ['Vrai', 'Faux'],
                'correct_indices' => [0],
                'confirm_text' => 'Oui, c\'est une moyenne.',
                'explain_text' => 'Le flux varie d\'une personne Ã  l\'autre et d\'un cycle Ã  l\'autre. L\'important est de connaÃ®tre son normal.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 20,
                'points' => 1
            ],
            // RÃ¨gles abondantes
            [
                'qtext' => 'Des rÃ¨gles sont dites abondantes si elles durent plus de 7 jours (souvent).',
                'qtype' => 'truefalse',
                'choices' => ['Vrai', 'Faux'],
                'correct_indices' => [0],
                'confirm_text' => '>7 jours = un signe.',
                'explain_text' => 'DurÃ©e longue rÃ©guliÃ¨re â†’ avis mÃ©dical (risque d\'anÃ©mie).',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 15,
                'points' => 1
            ],
            [
                'qtext' => '> 80 ml par cycle est un signe de rÃ¨gles abondantes.',
                'qtype' => 'truefalse',
                'choices' => ['Vrai', 'Faux'],
                'correct_indices' => [0],
                'confirm_text' => 'Oui.',
                'explain_text' => 'RepÃ¨res : â‰¥5 tampons super plus/jour ou cup qui se remplit trÃ¨s vite.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 15,
                'points' => 1
            ],
            [
                'qtext' => 'Protection qui se remplit en moins de 2 h rÃ©guliÃ¨rement = signe d\'abondance.',
                'qtype' => 'truefalse',
                'choices' => ['Vrai', 'Faux'],
                'correct_indices' => [0],
                'confirm_text' => 'Exact.',
                'explain_text' => 'Changer trÃ¨s souvent malgrÃ© une taille super est un indicateur. Parles-en pour Ã©viter l\'anÃ©mie.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 15,
                'points' => 1
            ],
            // Cycle
            [
                'qtext' => 'Combien de jours dure en moyenne un cycle menstruel ?',
                'qtype' => 'quiz',
                'choices' => ['21 jours', '28 jours', '35 jours', '40 jours'],
                'correct_indices' => [1],
                'confirm_text' => '28 jours en moyenne.',
                'explain_text' => 'Plage Â« normale Â» ~21â€“35 jours. La rÃ©gularitÃ© compte plus que le chiffre exact.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 20,
                'points' => 1
            ],
            [
                'qtext' => 'Les rÃ¨gles commencentâ€¦',
                'qtype' => 'quiz',
                'choices' => ['Au milieu du cycle', 'Au dÃ©but du cycle', 'Ã€ la fin du cycle', 'AprÃ¨s l\'ovulation'],
                'correct_indices' => [1],
                'confirm_text' => 'Jour 1 = premier jour des rÃ¨gles.',
                'explain_text' => 'Phases : Menstruelle â†’ Folliculaire â†’ Ovulation â†’ LutÃ©ale.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 20,
                'points' => 1
            ],
            [
                'qtext' => 'Combien y a-t-il de phases dans un cycle ?',
                'qtype' => 'quiz',
                'choices' => ['2', '3', '4', '5'],
                'correct_indices' => [2],
                'confirm_text' => '4 phases.',
                'explain_text' => 'Menstruelle, Folliculaire, Ovulation, LutÃ©ale.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 20,
                'points' => 1
            ],
            [
                'qtext' => 'L\'ovulation survient en gÃ©nÃ©ralâ€¦',
                'qtype' => 'quiz',
                'choices' => ['~14 jours aprÃ¨s les rÃ¨gles', '~14 jours avant les prochaines rÃ¨gles', 'Le jour 1 du cycle', 'Juste avant les rÃ¨gles suivantes'],
                'correct_indices' => [1],
                'confirm_text' => 'â‰ˆ 14 jours avant les prochaines rÃ¨gles.',
                'explain_text' => 'Le timing varie selon la longueur du cycle.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 25,
                'points' => 1
            ],
            // SantÃ© & hygiÃ¨ne
            [
                'qtext' => 'Â« La douleur des rÃ¨gles, il faut faire avec. Â»',
                'qtype' => 'truefalse',
                'choices' => ['Vrai', 'Faux'],
                'correct_indices' => [1],
                'confirm_text' => 'Faux.',
                'explain_text' => 'Des crampes lÃ©gÃ¨res sont frÃ©quentes, mais des douleurs intenses qui empÃªchent de vivre normalement ne sont pas Â« normales Â» â†’ consulter.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 20,
                'points' => 1
            ],
            [
                'qtext' => 'Le SPM (syndrome prÃ©menstruel), c\'estâ€¦',
                'qtype' => 'quiz',
                'choices' => ['Une envie irrÃ©sistible de sucreries', 'Un ensemble de symptÃ´mes physiques et Ã©motionnels', 'Une pÃ©riode oÃ¹ les rÃ¨gles sont plus abondantes', 'Une infection'],
                'correct_indices' => [1],
                'confirm_text' => 'Un ensemble de symptÃ´mes (avant les rÃ¨gles).',
                'explain_text' => 'Fatigue, irritabilitÃ©, ballonnements, seins sensiblesâ€¦ Si c\'est trÃ¨s handicapant : avis mÃ©dical.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 25,
                'points' => 1
            ],
            [
                'qtext' => 'Ã€ quelle frÃ©quence changer tampons ou serviettes ?',
                'qtype' => 'quiz',
                'choices' => ['Toutes les 2â€“8 heures', 'Toutes les 4â€“8 heures', 'Une fois par jour', 'Quand c\'est plein seulement'],
                'correct_indices' => [1],
                'confirm_text' => 'Toutes les 4â€“8 heures (jamais >8 h pour un tampon).',
                'explain_text' => 'Adapter selon le flux : hygiÃ¨ne + confort + prÃ©vention des odeurs/infections.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 20,
                'points' => 1
            ],
            [
                'qtext' => 'Pour la toilette intime pendant les rÃ¨gles, on privilÃ©gieâ€¦',
                'qtype' => 'quiz',
                'choices' => ['Eau + savon doux / nettoyant intime sans parfum', 'Eau uniquement', 'Savon parfumÃ©/gel douche classique', 'DÃ©sinfectant'],
                'correct_indices' => [0],
                'confirm_text' => 'Doux & sans parfum.',
                'explain_text' => 'Respecter le pH et Ã©viter les irritations.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 25,
                'points' => 1
            ],
            [
                'qtext' => 'Les douches vaginales sont recommandÃ©es pendant les rÃ¨gles.',
                'qtype' => 'truefalse',
                'choices' => ['Vrai', 'Faux'],
                'correct_indices' => [1],
                'confirm_text' => 'Ã€ Ã©viter.',
                'explain_text' => 'Elles perturbent la flore vaginale et favorisent les infections.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 20,
                'points' => 1
            ],
            [
                'qtext' => 'Ces signaux doivent faire consulter : rÃ¨gles trÃ¨s abondantes/prolongÃ©es, douleurs intenses, cycles absents/irrÃ©guliers, fatigue/pÃ¢leur/essoufflement.',
                'qtype' => 'truefalse',
                'choices' => ['Vrai', 'Faux'],
                'correct_indices' => [0],
                'confirm_text' => 'Oui, consultez dans ces cas.',
                'explain_text' => 'Pour Ã©carter endomÃ©triose, fibromes, troubles hormonaux, anÃ©mie.',
                'explain_media' => ['image' => '', 'video' => ''],
                'seconds' => 35,
                'points' => 2
            ]
        ];

        $stmt = $this->pdo->prepare("
            INSERT INTO questions (qtext, qtype, choices, correct_indices, confirm_text, explain_text, explain_media, seconds, points)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ");

        foreach ($questions as $question) {
            $stmt->execute([
                $question['qtext'],
                $question['qtype'],
                json_encode($question['choices']),
                json_encode($question['correct_indices']),
                $question['confirm_text'],
                $question['explain_text'],
                json_encode($question['explain_media']),
                $question['seconds'],
                $question['points']
            ]);
        }
    }
}
?>